---
layout: level
title: Game
---

<script src="game/libs/matter.js"></script>

<script type="module">

import { getLevelInitializers } from './game/levels.js'
import { Ball } from './game/objects/ball.js'
import { acceptUserInput } from './game/acceptUserInput.js'

// List of level intialializers; 1st item is null since there is no level 0
// They all accept the same exact arguments: engine and game_state.
let levelInits = getLevelInitializers();
let engine = Matter.Engine.create();// create an engine
let MAX_LEVEL = 5;
let current_level = 1;
let game_state = {  
    level_complete: false,
    drop_coords: null,
    total_platform_used: 0,
    par: 0
};
let ball = null;
let lastBallDrop = 0;

function setupInfoDisplay() {
    game_state.total_platform_used = 0;
    document.getElementById('level').innerText = 'Level: ' + current_level;
    // document.getElementById('par').innerText = 'Par: ' + game_state.par;
    // document.getElementById('total_platform_used').innerText = 'Total Platform Used: ' + game_state.total_platform_used;
}

function dropBall() {
    new Ball(game_state.drop_coords[0], game_state.drop_coords[1], engine);
    lastBallDrop = Date.now();
}

function buildRenderer() {
    let render = Matter.Render.create({
        element: document.body,
        engine: engine,
        options: {
            width: window.innerWidth,
            height: window.innerHeight,
            wireframes: false
        }
    });
    return render;
}

let renderer = buildRenderer();

// level reset routine
function resetLevel() {
    // Restart the engine and renderer to an intial state
    Matter.World.clear(engine.world, false);
    Matter.Engine.clear(engine);
    Matter.Render.stop(renderer);
    renderer.canvas.parentNode.removeChild(renderer.canvas);
    renderer = buildRenderer();

    levelInits[current_level](engine, game_state);
    setupInfoDisplay();
    dropBall();
    
    Matter.Render.run(renderer);// Restart the renderer
}

resetLevel();
document.getElementById('level-reset').onclick = resetLevel;// level reset button
acceptUserInput(engine, game_state);

Matter.Events.on(engine, 'collisionStart', function(event) {
        let pairs = event.pairs;
        for (let i = 0; i < pairs.length; i++) {
            let pair = pairs[i];
            pair.bodyA.gameObject.collisionStart(pair.bodyB);
            pair.bodyB.gameObject.collisionStart(pair.bodyA);
        }
    });
Matter.Events.on(engine, 'collisionEnd', function(event) {
        let pairs = event.pairs;
        for (let i = 0; i < pairs.length; i++) {
            let pair = pairs[i];
            pair.bodyA.gameObject.collisionEnd(pair.bodyB);
            pair.bodyB.gameObject.collisionEnd(pair.bodyA);
        }
    });

async function update() {
    if (Date.now() - lastBallDrop >= 3000) {
        dropBall();
    }

    if (game_state.level_complete == true) {
        await new Promise(resolve => setTimeout(resolve, 2000));// Pause for 2 seconds
        game_state.level_complete = false;
        current_level += 1;
        if (current_level > MAX_LEVEL) {
            console.log("woot! game over!"); 
            return;
        }
        resetLevel();
    }

    Matter.Engine.update(engine, 1000 / 60 );
    requestAnimationFrame(update);
}

// run the engine
requestAnimationFrame(update);

</script>